import{r,a as le,g as oe,c as p,o as d,d as t,w as l,e as i,E as s,u as se,h as j,f as u,i as k,j as ne,b as g,p as re,k as ie,s as ue,l as ce,m as q}from"./index-B3ZjBOUV.js";import{d as f,u as de}from"./index-BE28LO_H.js";import{_ as me}from"./_plugin-vue_export-helper-DlAUqK2U.js";const fe={class:"database-selector"},pe={class:"card-header"},_e={class:"header-actions"},ve={key:0,class:"loading-container"},ye={key:1,class:"empty-container"},ge={key:0,class:"filter-info"},be={key:1,class:"loading-container"},ke={key:2,class:"empty-container"},we={class:"dialog-footer"},De={class:"dialog-footer"},Ce={__name:"DatabaseSelector",setup(he){const I=se(),w=r([]),D=r(!0),C=r(""),h=r(""),B=r(!1),V=r(""),_=r(!1),m=le({name:""}),v=r(!1),$=r([]),x=r(!1),z=r(""),S=r(localStorage.getItem("username")||""),T=async()=>{D.value=!0;try{const a=await f.getUserDatabases();w.value=a.data.map(e=>({name:e}))}catch(a){console.error("获取数据库列表失败:",a),s.error("获取数据库列表失败")}finally{D.value=!1}},y=()=>{T()},W=async a=>{C.value=a;try{await f.startDatabase(a),s.success(`数据库 ${a} 启动成功`),U(a)}catch(e){console.error("启动数据库失败:",e),s.warning(`启动数据库 ${a} 失败，将直接使用该数据库`),U(a)}finally{C.value=""}},G=async a=>{h.value=a;try{await f.stopDatabase(),s.success(`数据库 ${a} 已停止`),y()}catch(e){console.error("停止数据库失败:",e),s.error(`停止数据库 ${a} 失败`)}finally{h.value=""}},U=a=>{localStorage.setItem("currentDatabase",a),I.push("/dashboard/graph")},H=()=>{v.value=!0,E()},E=async()=>{x.value=!0;try{const a=await f.getBackupList();if(a.data&&Array.isArray(a.data)){const e=a.data.filter(c=>S.value?c.startsWith(S.value):!0);$.value=e.map(c=>({name:c}))}}catch(a){console.error("获取备份列表失败:",a),s.error("获取备份列表失败")}finally{x.value=!1}},J=a=>{q.confirm("恢复备份会导致当前数据库被删除，确定要继续吗？","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{K(a)}).catch(()=>{s.info("已取消恢复操作")})},K=async a=>{z.value=a;try{await f.restoreDatabase(a),s.success("数据库恢复成功"),v.value=!1,y()}catch(e){console.error("恢复数据库失败:",e),s.error("恢复数据库失败")}finally{z.value=""}},O=()=>{_.value=!0,m.name=""},P=async()=>{if(!m.name){s.warning("请输入数据库名称");return}B.value=!0;try{await f.createDatabase(m.name),s.success(`数据库 ${m.name} 创建成功`),_.value=!1,y()}catch(a){console.error("创建数据库失败:",a),s.error("创建数据库失败")}finally{B.value=!1}},Q=a=>{q.confirm(`您确定要删除数据库 "${a}" 吗？此操作无法撤销，数据库中的所有数据将永久丢失！`,"警告",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"error",confirmButtonClass:"el-button--danger"}).then(()=>{X(a)}).catch(()=>{s.info("已取消删除操作")})},X=async a=>{V.value=a;try{await f.deleteDatabase(a),s.success(`数据库 ${a} 已成功删除`),y()}catch(e){console.error("删除数据库失败:",e),s.error(`删除数据库 ${a} 失败`)}finally{V.value=""}},Y=async()=>{try{await de.logout(),localStorage.removeItem("token"),localStorage.removeItem("username"),s.success("已退出登录"),I.push("/login")}catch(a){console.error("登出失败:",a),s.error("登出失败，请稍后再试")}};return oe(()=>{T()}),(a,e)=>{const c=i("el-icon"),n=i("el-button"),L=i("el-skeleton"),M=i("el-empty"),b=i("el-table-column"),F=i("el-table"),Z=i("el-card"),N=i("el-alert"),R=i("el-dialog"),ee=i("el-input"),ae=i("el-form-item"),te=i("el-form");return d(),p("div",fe,[t(Z,{class:"selector-card"},{header:l(()=>[g("div",pe,[e[9]||(e[9]=g("h2",null,"选择数据库",-1)),g("div",_e,[t(n,{type:"success",size:"small",onClick:O},{default:l(()=>[t(c,null,{default:l(()=>[t(k(re))]),_:1}),e[5]||(e[5]=u(" 创建数据库 "))]),_:1}),t(n,{type:"primary",size:"small",onClick:y},{default:l(()=>[t(c,null,{default:l(()=>[t(k(ie))]),_:1}),e[6]||(e[6]=u(" 刷新列表 "))]),_:1}),t(n,{type:"warning",size:"small",onClick:H},{default:l(()=>e[7]||(e[7]=[u(" 恢复备份 ")])),_:1}),t(n,{type:"danger",size:"small",onClick:Y},{default:l(()=>[t(c,null,{default:l(()=>[t(k(ue))]),_:1}),e[8]||(e[8]=u(" 退出登录 "))]),_:1})])])]),default:l(()=>[D.value?(d(),p("div",ve,[t(L,{rows:3,animated:""})])):w.value.length===0?(d(),p("div",ye,[t(M,{description:"暂无可用数据库"})])):(d(),j(F,{key:2,data:w.value,style:{width:"100%"}},{default:l(()=>[t(b,{prop:"name",label:"数据库名称"}),t(b,{label:"操作",width:"240"},{default:l(o=>[t(n,{type:"success",size:"small",onClick:A=>W(o.row.name),loading:C.value===o.row.name},{default:l(()=>e[10]||(e[10]=[u(" 使用 ")])),_:2},1032,["onClick","loading"]),t(n,{type:"danger",size:"small",onClick:A=>G(o.row.name),loading:h.value===o.row.name},{default:l(()=>e[11]||(e[11]=[u(" 停止 ")])),_:2},1032,["onClick","loading"]),t(n,{type:"danger",size:"small",onClick:A=>Q(o.row.name),loading:V.value===o.row.name},{default:l(()=>[t(c,null,{default:l(()=>[t(k(ne))]),_:1}),e[12]||(e[12]=u(" 删除 "))]),_:2},1032,["onClick","loading"])]),_:1})]),_:1},8,["data"]))]),_:1}),t(R,{modelValue:v.value,"onUpdate:modelValue":e[1]||(e[1]=o=>v.value=o),title:"恢复数据库备份",width:"600px"},{footer:l(()=>[g("div",we,[t(n,{onClick:e[0]||(e[0]=o=>v.value=!1)},{default:l(()=>e[14]||(e[14]=[u("关闭")])),_:1}),t(n,{type:"primary",onClick:E},{default:l(()=>e[15]||(e[15]=[u("刷新列表")])),_:1})])]),default:l(()=>[S.value?(d(),p("div",ge,[t(N,{title:"备份文件过滤",type:"info",closable:!1,description:"当前仅显示以您用户名开头的备份文件"})])):ce("",!0),x.value?(d(),p("div",be,[t(L,{rows:3,animated:""})])):$.value.length===0?(d(),p("div",ke,[t(M,{description:"暂无可用备份"})])):(d(),j(F,{key:3,data:$.value,style:{width:"100%"}},{default:l(()=>[t(b,{prop:"name",label:"备份文件名"}),t(b,{label:"操作",width:"100"},{default:l(o=>[t(n,{type:"primary",size:"small",onClick:A=>J(o.row.name),loading:z.value===o.row.name},{default:l(()=>e[13]||(e[13]=[u(" 恢复 ")])),_:2},1032,["onClick","loading"])]),_:1})]),_:1},8,["data"]))]),_:1},8,["modelValue"]),t(R,{modelValue:_.value,"onUpdate:modelValue":e[4]||(e[4]=o=>_.value=o),title:"创建数据库",width:"400px"},{footer:l(()=>[g("div",De,[t(n,{onClick:e[3]||(e[3]=o=>_.value=!1)},{default:l(()=>e[16]||(e[16]=[u("取消")])),_:1}),t(n,{type:"primary",onClick:P,loading:B.value},{default:l(()=>e[17]||(e[17]=[u("创建")])),_:1},8,["loading"])])]),default:l(()=>[t(te,{model:m,"label-width":"100px"},{default:l(()=>[t(ae,{label:"数据库名称",required:""},{default:l(()=>[t(ee,{modelValue:m.name,"onUpdate:modelValue":e[2]||(e[2]=o=>m.name=o),placeholder:"请输入数据库名称"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},xe=me(Ce,[["__scopeId","data-v-3051d0fb"]]);export{xe as default};
